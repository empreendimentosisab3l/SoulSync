// schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Tabela de Quizzes
model Quiz {
  id          String   @id @default(uuid())
  name        String
  version     String
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  isActive    Boolean  @default(true)

  // Relações
  sessions    QuizSession[]

  @@map("quizzes")
}

// Tabela de Sessões (cada vez que alguém inicia o quiz)
model QuizSession {
  id            String    @id @default(uuid())
  quizId        String
  userId        String?   // IP ou fingerprint do usuário
  startedAt     DateTime  @default(now())
  completedAt   DateTime?
  convertedAt   DateTime?
  email         String?
  name          String?
  revenue       Decimal?  @db.Decimal(10, 2)

  // UTM parameters
  utmSource     String?
  utmMedium     String?
  utmCampaign   String?
  utmContent    String?
  utmTerm       String?

  // Device info
  deviceType    String?
  browser       String?
  os            String?
  screenWidth   Int?
  screenHeight  Int?

  // Relações
  quiz          Quiz      @relation(fields: [quizId], references: [id], onDelete: Cascade)
  events        QuizEvent[]
  conversions   Conversion[]

  @@index([quizId])
  @@index([startedAt])
  @@index([email])
  @@map("quiz_sessions")
}

// Tabela de Eventos (cada interação no quiz)
model QuizEvent {
  id              String   @id @default(uuid())
  sessionId       String
  cardNumber      Int
  cardName        String?
  eventType       String   // 'view', 'answer', 'abandon', 'complete'
  timeSpentSeconds Int?
  answerValue     String?  // JSON string
  createdAt       DateTime @default(now())

  // Relações
  session         QuizSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId])
  @@index([cardNumber])
  @@index([eventType])
  @@map("quiz_events")
}

// Tabela de Conversões
model Conversion {
  id            String   @id @default(uuid())
  sessionId     String
  amount        Decimal  @db.Decimal(10, 2)
  couponCode    String?
  paymentMethod String?
  createdAt     DateTime @default(now())

  // Relações
  session       QuizSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId])
  @@index([createdAt])
  @@map("conversions")
}

// Tabela de Usuários Admin (para o dashboard)
model User {
  id        String   @id @default(uuid())
  username  String   @unique
  password  String   // Hash bcrypt
  email     String?  @unique
  createdAt DateTime @default(now())

  @@map("users")
}
